<% content_for :title, "Libraries" %>

<div class="row">
  <div class="col-md-12">
    <h1>Libraries</h1>
    <p class="text-muted">Find libraries near you where you can borrow books from our collection.</p>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div id="map" style="height: 500px; width: 100%;"></div>
  </div>
  <div class="col-md-4">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Library List</h3>
      </div>
      <div class="panel-body" style="max-height: 500px; overflow-y: auto;">
        <% @libraries.each do |library| %>
          <div class="library-item" data-lat="<%= library.latitude %>" data-lng="<%= library.longitude %>">
            <h4><%= link_to library.name, library %></h4>
            <p><i class="glyphicon glyphicon-map-marker"></i> <%= library.address %></p>
            <p><i class="glyphicon glyphicon-earphone"></i> <%= library.phone %></p>
            <p><i class="glyphicon glyphicon-globe"></i> <%= link_to 'Website', library.website, target: '_blank' %></p>
            <hr>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>



<script>
  // Fallback for when Google Maps API fails to load
  window.initMap = function() {
    // Check if Google Maps loaded successfully
    if (typeof google !== 'undefined' && google.maps) {
      // Google Maps loaded successfully, call the real initMap function
      realInitMap();
    } else {
      // Google Maps failed to load, show fallback message
      document.getElementById('map').innerHTML = '<div class="alert alert-warning" style="height: 100%; display: flex; align-items: center; justify-content: center;"><h4>Oops! Something went wrong with the map.</h4><p>Please check your internet connection or try refreshing the page.</p><p><strong>Note:</strong> The Google Maps API key may be invalid or restricted.</p></div>';
    }
  };

  function realInitMap() {
    // Default center (can be user's location)
    const defaultCenter = { lat: 39.8283, lng: -98.5795 }; // Center of USA

    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 4,
      center: defaultCenter
    });

    // Add markers for each library
    <% @libraries.each do |library| %>
      const marker<%= library.id %> = new google.maps.Marker({
        position: { lat: <%= library.latitude %>, lng: <%= library.longitude %> },
        map: map,
        title: '<%= library.name %>'
      });

      const infowindow<%= library.id %> = new google.maps.InfoWindow({
        content: `
          <div>
            <h4><%= library.name %></h4>
            <p><%= library.address %></p>
            <p>Phone: <%= library.phone %></p>
            <p><a href="<%= library.website %>" target="_blank">Visit Website</a></p>
          </div>
        `
      });

      marker<%= library.id %>.addListener('click', function() {
        infowindow<%= library.id %>.open(map, marker<%= library.id %>);
      });
    <% end %>

    // Try to get user's location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setCenter(userLocation);
        map.setZoom(10);

        // Add user marker
        const userMarker = new google.maps.Marker({
          position: userLocation,
          map: map,
          title: 'Your Location',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#4285F4',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
          }
        });
      });
    }

    console.log('Map initialized with <%= @libraries.count %> libraries');
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCY77LfLABuEYvm6GltmB7fEuGKgzoiD1k&callback=initMap"></script>

<%= link_to "New library", new_library_path, class: 'btn btn-primary' %>
